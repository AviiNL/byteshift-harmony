"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");var e=require("http"),t=require("https");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=s(e),i=s(t);class E{constructor(e){this.keys={},this.data={},e&&this.insert(e)}get size(){return Object.keys(this.data).length}insert(e){Object.keys(e).forEach((t=>{this.set(t,e[t])}))}get(e){return this.data[e.toLowerCase()]}has(e){return void 0!==this.data[e.toLowerCase()]}set(e,t){void 0===this.keys[e]&&(this.keys[e.toLowerCase()]=e),this.data[e.toLowerCase()]=t}get all(){const e={};return Object.keys(this.data).forEach((t=>{e[this.keys[t]]=this.data[t]})),e}forEach(e){Object.keys(this.data).forEach((t=>{e(this.data[t],this.keys[t])}))}}const o=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;const a=/\((.*?)\)/g,n=/(\(\?)?:\w+/g,_=/[\-{}\[\]+?.,\\^$|#\s]/g,h=/\*/g;class T{constructor(e){this.r=e;const t=new URL(e.url,"http://localhost/"),s={};t.searchParams.forEach(((e,t)=>s[t]=e)),this._clientIp=e.socket.remoteAddress,this._method=e.method.toUpperCase(),this._path=t.pathname,this._headers=new E(e.headers),this._cookies=new E(e.headers.cookie?this._parseCookies(e.headers.cookie):{}),this._query=new E(s),this._parameters=new E}get(e){return this._cookies.has(e)?this._cookies.get(e):this._headers.has(e)?this._headers.get(e):this._parameters.has(e)?this._parameters.get(e):this._query.has(e)?this._query.get(e):void 0}get clientIp(){return this._clientIp}get path(){return this._path}get method(){return this._method}get cookies(){return this._cookies}get headers(){return this._headers}get query(){return this._query}get parameters(){return this._parameters}isMatchingRoute(e){if(this.method!==e.method)return!1;e._matcher||(e._matcher=this._parsePattern(e.path));let t=e._matcher.regExp.exec(this.path);return!!t&&(t=t.slice(1,-1),t.reduce(((t,s,r)=>(s&&this._parameters.set(e._matcher.namedParams[r],s),t)),{}),!0)}_parsePattern(e){let t=[];return e=e.replace(_,"\\$&").replace(a,"(?:$1)?").replace(n,(function(e,s){return t.push(e.slice(1)),s?e:"([^/?]+)"})).replace(h,(function(){return t.push("path"),"([^?]*?)"})),{regExp:new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$"),namedParams:t}}_parseCookies(e){if("string"!=typeof e)return{};const t=e.split(/; */);for(let e=0;e<t.length;e++){let s=t[e],r=s.indexOf("=");if(r<1)continue;s.substr(0,r).trim();let i=s.substr(++r,s.length).trim();'"'==i[0]&&(i=i.slice(1,-1))}return{}}}class O{constructor(e,t=exports.HttpStatus.OK,s="text/plain"){this._code=exports.HttpStatus.OK,this._content="",this._isSent=!1,this._headers=new E,this._cookies=new E,this.content=e,this.contentType=s,this.statusCode=t}set statusCode(e){this._code=e}set contentType(e){this._headers.set("Content-Type",e)}set content(e){this._content=e}get isSent(){return this._isSent}send(e){if(this._isSent)throw new Error("This response was already sent.");this._isSent=!0,e.writeHead(this._code,this._headers.all),this._cookies.size>0&&this._cookies.forEach((t=>{e.setHeader("Set-Cookie",t.serialize())})),e.write(this._content),e.end()}}var R;(R=exports.HttpStatus||(exports.HttpStatus={}))[R.CONTINUE=100]="CONTINUE",R[R.SWITCHING_PROTOCOLS=101]="SWITCHING_PROTOCOLS",R[R.PROCESSING=102]="PROCESSING",R[R.EARLY_HINTS=103]="EARLY_HINTS",R[R.OK=200]="OK",R[R.CREATED=201]="CREATED",R[R.ACCEPTED=202]="ACCEPTED",R[R.NON_AUTHORITATIVE_INFORMATION=203]="NON_AUTHORITATIVE_INFORMATION",R[R.NO_CONTENT=204]="NO_CONTENT",R[R.RESET_CONTENT=205]="RESET_CONTENT",R[R.PARTIAL_CONTENT=206]="PARTIAL_CONTENT",R[R.MULTI_STATUS=207]="MULTI_STATUS",R[R.ALREADY_REPORTED=208]="ALREADY_REPORTED",R[R.IM_USED=226]="IM_USED",R[R.MULTIPLE_CHOICES=300]="MULTIPLE_CHOICES",R[R.MOVED_PERMANENTLY=301]="MOVED_PERMANENTLY",R[R.FOUND=302]="FOUND",R[R.SEE_OTHER=303]="SEE_OTHER",R[R.NOT_MODIFIED=304]="NOT_MODIFIED",R[R.USE_PROXY=305]="USE_PROXY",R[R.RESERVED=306]="RESERVED",R[R.TEMPORARY_REDIRECT=307]="TEMPORARY_REDIRECT",R[R.PERMANENTLY_REDIRECT=308]="PERMANENTLY_REDIRECT",R[R.BAD_REQUEST=400]="BAD_REQUEST",R[R.UNAUTHORIZED=401]="UNAUTHORIZED",R[R.PAYMENT_REQUIRED=402]="PAYMENT_REQUIRED",R[R.FORBIDDEN=403]="FORBIDDEN",R[R.NOT_FOUND=404]="NOT_FOUND",R[R.METHOD_NOT_ALLOWED=405]="METHOD_NOT_ALLOWED",R[R.NOT_ACCEPTABLE=406]="NOT_ACCEPTABLE",R[R.PROXY_AUTHENTICATION_REQUIRED=407]="PROXY_AUTHENTICATION_REQUIRED",R[R.REQUEST_TIMEOUT=408]="REQUEST_TIMEOUT",R[R.CONFLICT=409]="CONFLICT",R[R.GONE=410]="GONE",R[R.LENGTH_REQUIRED=411]="LENGTH_REQUIRED",R[R.PRECONDITION_FAILED=412]="PRECONDITION_FAILED",R[R.REQUEST_ENTITY_TOO_LARGE=413]="REQUEST_ENTITY_TOO_LARGE",R[R.REQUEST_URI_TOO_LONG=414]="REQUEST_URI_TOO_LONG",R[R.UNSUPPORTED_MEDIA_TYPE=415]="UNSUPPORTED_MEDIA_TYPE",R[R.REQUESTED_RANGE_NOT_SATISFIABLE=416]="REQUESTED_RANGE_NOT_SATISFIABLE",R[R.EXPECTATION_FAILED=417]="EXPECTATION_FAILED",R[R.I_AM_A_TEAPOT=418]="I_AM_A_TEAPOT",R[R.MISDIRECTED_REQUEST=421]="MISDIRECTED_REQUEST",R[R.UNPROCESSABLE_ENTITY=422]="UNPROCESSABLE_ENTITY",R[R.LOCKED=423]="LOCKED",R[R.FAILED_DEPENDENCY=424]="FAILED_DEPENDENCY",R[R.TOO_EARLY=425]="TOO_EARLY",R[R.UPGRADE_REQUIRED=426]="UPGRADE_REQUIRED",R[R.PRECONDITION_REQUIRED=428]="PRECONDITION_REQUIRED",R[R.TOO_MANY_REQUESTS=429]="TOO_MANY_REQUESTS",R[R.REQUEST_HEADER_FIELDS_TOO_LARGE=431]="REQUEST_HEADER_FIELDS_TOO_LARGE",R[R.UNAVAILABLE_FOR_LEGAL_REASONS=451]="UNAVAILABLE_FOR_LEGAL_REASONS",R[R.INTERNAL_SERVER_ERROR=500]="INTERNAL_SERVER_ERROR",R[R.NOT_IMPLEMENTED=501]="NOT_IMPLEMENTED",R[R.BAD_GATEWAY=502]="BAD_GATEWAY",R[R.SERVICE_UNAVAILABLE=503]="SERVICE_UNAVAILABLE",R[R.GATEWAY_TIMEOUT=504]="GATEWAY_TIMEOUT",R[R.VERSION_NOT_SUPPORTED=505]="VERSION_NOT_SUPPORTED",R[R.VARIANT_ALSO_NEGOTIATES_EXPERIMENTAL=506]="VARIANT_ALSO_NEGOTIATES_EXPERIMENTAL",R[R.INSUFFICIENT_STORAGE=507]="INSUFFICIENT_STORAGE",R[R.LOOP_DETECTED=508]="LOOP_DETECTED",R[R.NOT_EXTENDED=510]="NOT_EXTENDED",R[R.NETWORK_AUTHENTICATION_REQUIRED=511]="NETWORK_AUTHENTICATION_REQUIRED";class c{constructor(){this.routes=[]}registerController(e){void 0!==e.prototype.__ROUTES__?Object.keys(e.prototype.__ROUTES__).forEach((t=>{e.prototype.__ROUTES__[t].forEach((s=>{(Array.isArray(s.method)?s.method:[s.method]).forEach((r=>{this.routes.push({path:s.path,method:r,signature:s.signature,_controller:[e,t]})}))}))})):console.warn("Given controller has no registered routes.")}findByRequest(e){const t=this.routes.find((t=>e.isMatchingRoute(t)));if(t)return t}}exports.Bag=E,exports.Cookie=class{constructor(e,t){this.name=e,this.value=t,this.maxAge=0,this.domain=null,this.path="/",this.expires=null,this.httpOnly=null,this.secure=null,this.sameSite=null}serialize(){if(!o.test(this.name))throw new Error('Failed to serialize cookie "'+this.name+'" due to invalid characters in the name.');if(!o.test(this.value))throw new Error('Failed to serialize cookie "'+this.value+'" due to invalid characters in the value.');let e=this.name+"="+encodeURIComponent(this.value);if(this.maxAge){const t=this.maxAge-0;if(isNaN(t)||!isFinite(t))throw new TypeError('maxAge of cookie "'+this.name+'" is invalid');e+="; Max-Age="+Math.floor(t)}if(this.domain){if(!o.test(this.domain))throw new Error('Failed to serialize cookie "'+this.name+'" due to invalid characters in the domain property.');e+="; Domain="+this.domain}if(this.path){if(!o.test(this.path))throw new Error('Failed to serialize cookie "'+this.name+'" due to invalid characters in the path property.');e+="; Path="+this.path}if(this.expires){if(!(this.expires instanceof Date))throw new Error('Failed to serialize cookie "'+this.name+'" because "expires" is expected to be a Date object.');e+="; Expires="+this.expires.toUTCString()}if(this.httpOnly&&(e+="; HttpOnly"),this.secure&&(e+="; Secure"),this.sameSite)switch(this.sameSite){case!0:case"strict":e+="; SameSite=Strict";break;case"lax":e+="; SameSite=Lax";break;case"none":e+="; SameSite=None"}return e}},exports.Request=T,exports.Response=O,exports.Route=function(e,t){return t=t||{},function(s,r,i){void 0===s.__ROUTES__&&(s.__ROUTES__={}),void 0===s.__ROUTES__[r]&&(s.__ROUTES__[r]=[]);const E=[],o=Reflect.getMetadata("design:paramtypes",s,r),a=/^(\w+)\(([A-Za-z0-9_,\s]+)\)/i.exec(s[r].toString()),n=a&&a[2]?a[2].split(",").map((e=>e.trim())):[];if(n)for(let e=0;e<n.length;e++)E.push({name:n[e],type:o[e]});s.__ROUTES__[r].push({path:e,method:t.method||"GET",signature:E})}},exports.Router=c,exports.Server=class{constructor(e){this.options=e,this.router=new c,this.server=e.useHttps?i.default.createServer(e.sslOptions,this.handle.bind(this)):r.default.createServer(this.handle.bind(this))}start(){this.server.listen(this.options.port||8e3)}registerController(e){this.router.registerController(e)}async handle(e,t){const s=new T(e),r=this.router.findByRequest(s);if(!r)return this.send404(t);const i=this.options.serviceContainer?this.options.serviceContainer.get(r._controller[0]):new r._controller[0];if("function"!=typeof i[r._controller[1]])return console.error('Method "'+r._controller[1]+'" is not an accessible method in this controller.'),this.send500(t);const E=await this.handleControllerAction(i,r._controller[1],r,s);if(!(E instanceof O))return console.error('Method "'+r._controller[1]+'" did not return a Response object.'),this.send500(t);E.isSent||E.send(t)}async handleControllerAction(e,t,s,r){const i=e[t],E=[],o=Object.values(r.parameters.all);for(let e=0;e<s.signature.length;e++){s.signature[e].type===T?(E.push(r),o.unshift(null)):E.push(o[e])}return await i(...E)}send404(e){e.writeHead(404),e.write("Not found"),e.end()}send500(e){e.writeHead(500),e.write("Internal Server Error"),e.end()}};
//# sourceMappingURL=index.js.map
